%    Asano et al. give the following population SD's for the individual
%    difference parameters (their Table 5, Step 2 numbers:
%       Lens    - 18.7%
%       Macular - 36.5%
%       L Density - 9%
%       M Density - 9%
%       S Density - 7.4%
%       L Shift   - 2 nm
%       M Shift   - 1.5 nm
%       S Shift   - 1.3 nm

% Initialize
clear; close all;

% Get the stimuli settings for angles in the LS plane
% Load a CRT calibration file
cal = LoadCalFile('ViewSonicG220fb',[],getpref('ColorTracking','CalFolder'));

% Make calibration file compatible with current system
[calStructOBJ, inputArgIsACalStructOBJ] = ObjectToHandleCalOrCalStruct(cal);

% Set number of bits for display
nMonitorBits = 12;
nInputLevels = 2.^nMonitorBits;
CalibrateFitGamma(calStructOBJ, nInputLevels);
SetGammaMethod(calStructOBJ,2);

% Load the stim settings ans max contrasts for angles 80:0.05:100
% These are generated by cacheStimSettingsAsanso and then saved
% out by hand.
projectDir = tbLocateProject('ColorTracking');
cacheFileDir = fullfile(projectDir,'code','analysis','coneBootstrap');
settingsData = load(fullfile(cacheFileDir,'cacheStimSettingAsanoBoot.mat'));

% Baseline fundamentals
S = [380 5 81];
coneParams = DefaultConeParams('cie_asano');
coneParams.ageYears = 32;
coneParams.fieldSizeDegrees = 2;

% Load ss2 fundamentals
load T_cones_ss2

% Outer loop over Asano parameters
theAngles = 80:0.05:100;
nAsanoBoots = 10000;
CHECK_NOMINAL = 0;
for aa = 1:nAsanoBoots

    % Draw 8 parameters with standard deviations as in comment above
    switch (CHECK_NOMINAL)
        case 0
            drawLens     = normrnd(0,18.7);
            drawMacular  = normrnd(0,36.5);
            drawLDensity = normrnd(0,9);
            drawMDensity = normrnd(0,9);
            drawSDensity = normrnd(0,7.4);
            drawLShift   = normrnd(0,2);
            drawMShift   = normrnd(0,1.5);
            drawSShift   = normrnd(0,1.3);
            while drawMacular > 100 || drawMacular < -100
                drawMacular  = normrnd(0,36.5);
            end

            % Construct cone fundamentas with those parameters
            tmpConeParams = coneParams;
            tmpConeParams.indDiffParams.lambdaMaxShift = [drawLShift drawMShift drawSShift];
            tmpConeParams.indDiffParams.dphotopigment  = [drawLDensity drawMDensity drawSDensity];
            tmpConeParams.indDiffParams.dlens = drawLens;
            tmpConeParams.indDiffParams.dmac = drawMacular;
            tmpConeParams.fieldSizeDegrees = 2;
            [~,T1] = ComputeObserverFundamentals(tmpConeParams,S_cones_ss2);
        case 1
            drawLens     = 0;
            drawMacular  = 0;
            drawLDensity = 0;
            drawMDensity = 0;
            drawSDensity = 0;
            drawLShift   = 0;
            drawMShift   = 0;
            drawSShift   = 0;

            % Construct cone fundamentas with those parameters
            tmpConeParams = coneParams;
            tmpConeParams.indDiffParams.lambdaMaxShift = [drawLShift drawMShift drawSShift];
            tmpConeParams.indDiffParams.dphotopigment  = [drawLDensity drawMDensity drawSDensity];
            tmpConeParams.indDiffParams.dlens = drawLens;
            tmpConeParams.indDiffParams.dmac = drawMacular;
            tmpConeParams.fieldSizeDegrees = 2;
            [~,T1] = ComputeObserverFundamentals(tmpConeParams,S_cones_ss2);
        case 2
            T1 = T_cones_ss2;
    end
    
    % Standard initialization of calibration structure with modified cones
    SetSensorColorSpace(calStructOBJ,T1,S_cones_ss2);

    %% Set the background
    backgroundPrimaries = [0.50 0.50 0.50]'; %SensorToSettings(calStructOBJ,backgroundLMS);
    backgroundLMS_hat = SettingsToSensor(calStructOBJ,PrimaryToSettings(calStructOBJ,backgroundPrimaries));

    comparisonLMS1 = SettingsToSensor(calStructOBJ,settingsData.stimSettings);
    backgroundLMS1 = repmat(backgroundLMS_hat,[1,size(comparisonLMS1,2)]);
    contrastsLMS1 = ExcitationsToContrast(comparisonLMS1,backgroundLMS1);

    % Compute luminance contrast
    w = 2;
    backgroundLum1 = [w,1,0]*backgroundLMS1;
    luminances1 = [w,1,0]*comparisonLMS1;
    lumContrasts1 = (luminances1-backgroundLum1(1:size(comparisonLMS1,2))) ./ backgroundLum1(1:size(comparisonLMS1,2));

    whichLumAngle = find(abs(lumContrasts1) == min(abs(lumContrasts1)));
    whichLAngle = find(abs(contrastsLMS1(1,:)) == min(abs(contrastsLMS1(1,:))));
    whichMAngle = find(abs(contrastsLMS1(2,:)) == min(abs(contrastsLMS1(2,:))));

    minLumAngle(aa)     = theAngles(whichLumAngle);
    lumContrasts_minLumAngle(aa) = lumContrasts1(whichLumAngle);
    LContrasts_minLumAngle(aa)   = contrastsLMS1(1,whichLumAngle);
    MContrasts_minLumAngle(aa)   = contrastsLMS1(2,whichLumAngle);
    SContrasts_minLumAngle(aa)   = contrastsLMS1(3,whichLumAngle);

    minLAngle(aa)     = theAngles(whichLAngle);
    lumContrasts_minLAngle(aa) = lumContrasts1(whichLAngle);
    LContrasts_minLAngle(aa)   = contrastsLMS1(1,whichLAngle);
    MContrasts_minLAngle(aa)   = contrastsLMS1(2,whichLAngle);
    SContrasts_minLAngle(aa)   = contrastsLMS1(3,whichLAngle);

    minMAngle(aa)     = theAngles(whichMAngle);
    lumContrasts_minMAngle(aa) = lumContrasts1(whichMAngle);
    LContrasts_minMAngle(aa)   = contrastsLMS1(1,whichMAngle);
    MContrasts_minMAngle(aa)   = contrastsLMS1(2,whichMAngle);
    SContrasts_minMAngle(aa)   = contrastsLMS1(3,whichMAngle);

end

% Plot distribution of theta's, etc.
% Min lum angle plot
figure; set(gcf,'Position',[10 10 1800 600]);
subplot(1,5,1);
h1 = histogram(minLumAngle,77);
ylabel('Count')
xlabel('Angle in LS Plane')
title('Minimum Luminance Contrast Angle')
set(gcf,'Color','w');
xlim([86 94]);
ylim([0 700])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,2);
h1 = histogram(lumContrasts_minLumAngle,77);
ylabel('Count')
xlabel('Luminance Contrast')
title('Luminance Contrast at Minimum Luminance Angle')
set(gcf,'Color','w');
%xlim([-0.2 0.2]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,3);
h1 = histogram(LContrasts_minLumAngle,77);
ylabel('Count')
xlabel('L Contrast')
title('L Contrast at Minimum Luminance Angle')
set(gcf,'Color','w');
%xlim([-0.03 0.03])
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,4);
h1 = histogram(MContrasts_minLumAngle,77);
ylabel('Count')
xlabel('M Contrast')
title('M Contrast at Minimum Luminance Angle')
set(gcf,'Color','w');
%xlim([-0.06 0.06]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,5);
h1 = histogram(SContrasts_minLumAngle,77);
ylabel('Count')
xlabel('S Contrast')
title('S Contrast at Minimum Luminance Angle')
set(gcf,'Color','w');
xlim([0.75 0.85]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

% Min L angle plots
figure; set(gcf,'Position',[10 10 1800 600]);
subplot(1,5,1);
h1 = histogram(minLAngle,77);
ylabel('Count')
xlabel('Angle in LS Plane')
title('Minimum L Contrast Angle')
set(gcf,'Color','w');
xlim([86 94]);
ylim([0 700]);
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,2);
h1 = histogram(lumContrasts_minLAngle,77);
ylabel('Count')
xlabel('Luminance Contrast')
title('Luminance Contrast at Minimum L Angle')
set(gcf,'Color','w');
xlim([-0.2 0.2]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,3);
h1 = histogram(LContrasts_minLAngle,77);
ylabel('Count')
xlabel('L Contrast')
title('L Contrast at Minimum L Angle')
set(gcf,'Color','w');
xlim([-0.03 0.03])
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,4);
h1 = histogram(MContrasts_minLAngle,77);
ylabel('Count')
xlabel('M Contrast')
title('M Contrast at Minimum L Angle')
set(gcf,'Color','w');
xlim([-0.06 0.06]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,5);
h1 = histogram(SContrasts_minLAngle,77);
ylabel('Count')
xlabel('S Contrast')
title('S Contrast at Minimum L Angle')
set(gcf,'Color','w');
xlim([0.75 0.85]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

% Min M angle plots
figure; set(gcf,'Position',[10 10 1800 600]);
subplot(1,5,1);
h1 = histogram(minMAngle,77);
ylabel('Count')
xlabel('Angle in LS Plane')
title('Minimum M Contrast Angle')
set(gcf,'Color','w');
xlim([86 94]);
ylim([0 700]);
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,2);
h1 = histogram(lumContrasts_minMAngle,77);
ylabel('Count')
xlabel('Luminance Contrast')
title('Luminance Contrast at Minimum M Angle')
set(gcf,'Color','w');
xlim([-0.2 0.2]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,3);
h1 = histogram(LContrasts_minMAngle,77);
ylabel('Count')
xlabel('L Contrast')
title('L Contrast at Minimum M Angle')
set(gcf,'Color','w');
xlim([-0.03 0.03])
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,4);
h1 = histogram(MContrasts_minMAngle,77);
ylabel('Count')
xlabel('M Contrast')
title('M Contrast at Minimum M Angle')
set(gcf,'Color','w');
xlim([-0.06 0.06])
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square

subplot(1,5,5);
h1 = histogram(SContrasts_minMAngle,77);
ylabel('Count')
xlabel('S Contrast')
title('S Contrast at Minimum M Angle')
set(gcf,'Color','w');
xlim([0.75 0.85]);
ylim([0 550])
set(gca, ...
    'Box'         , 'off'     , ...
    'TickDir'     , 'out'     , ...
    'TickLength'  , [.02 .02] , ...
    'XMinorTick'  , 'off'      , ...
    'YMinorTick'  , 'off'      , ...
    'YGrid'       , 'on'      , ...
    'XColor'      , [.3 .3 .3], ...
    'YColor'      , [.3 .3 .3], ...
    'LineWidth'   , 1, ...
    'FontSize'    , 12);
axis square


